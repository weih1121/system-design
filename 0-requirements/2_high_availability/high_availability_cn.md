# 确定非功能性需求

在面试的开始阶段确定非功能性需求非常重要。我们已经知道这一点。但问题来了：潜在的非功能性需求清单很长——有几十个。我们需要理解并记住所有这些吗？**不需要**。让我们来讨论几个最常见的。

面试官很可能会让你专注于列表中的两到三个需求。在此过程中，我会提醒你几个重要的术语。与面试官或工作中的团队成员使用行业术语交谈总是加分项。

## 高可用性

**可用性**一词有多种定义方式。可用性通常用于定义系统的正常运行时间——系统工作和可用的时间百分比。例如，**99% 的可用性**意味着系统每年大约有 **3.65 天**不可用。

但在实践中，你经常会发现可用性被测量为请求的成功率——成功请求的数量除以系统中的总请求数量。在这种情况下，**99% 的可用性**意味着每 100 个请求中有一个失败。而且请求失败的原因并不重要：

- 可能是由于服务器端的错误。
- 可能是响应未及时返回。
- 或者可能是网络中断，导致请求根本没有到达服务器。

最后一个例子很有趣，因为它立即显示了可用性可能因视角而异。在网络故障的情况下，对客户端来说可用性下降了，因为系统对他们不可用。但服务器可能声称有 100% 的可用性，因为系统一直在运行。

因此，**视角很重要**。作为系统工程师，我们真正关心的是**客户的体验**，而不是服务器的视角。

在设计对可用性重要的系统时，我们的目标是**最大化可用性**——使其尽可能高。但高可用性究竟意味着什么？98% 足够高吗？还是 99%？或者必须是 100% 才能被认为是高度可用的系统？

实际上，都不是。当然，**100% 的可用性是不可能的**。我的意思是，理论上是可能的，但在实践中，在任意大的时间间隔内实现 100% 的可用性会导致非常复杂的设计和高昂的成本。无论我们多么努力，都会有一系列的硬件和软件故障伴随着人为错误，导致系统故障。

### 为高可用性而设计

这不仅仅是一个具体的数字，而是关于**系统架构和流程**。系统必须在设计、实现、测试和维护时考虑高可用性。只有这样，我们才能声称系统是高度可用的。

想象以下情况：我们创建了一个 Web 应用程序，并将其部署到**单个生产服务器**。服务器和网络在整个一周内都运行良好，这意味着在整个时间内所有请求都已成功处理。这样的系统可用性是 100%，对吧？是的。但系统是高度可用的吗？**不是**。如果单个服务器宕机，整个系统就不可用了。谁知道它何时会再次可用？

因此，**高可用性涉及架构和流程两方面**。这意味着，为了创建一个高度可用的系统，我们首先需要了解并应用一些**系统设计原则**。好消息是，这些原则归结为有限数量的特定系统设计概念。我们只需要知道这些概念，并在设计阶段将它们融入系统架构中。

此外，我们需要建立并遵循一套**流程**，以帮助确保系统随着时间的推移保持高可用性。

为什么我们需要这些流程？为什么仅有架构还不够？因为**系统不是静态的**。它们会发生变化。我们会向系统添加新功能，发现并修复错误，系统的负载可能会增加。我们必须升级软件并部署安全补丁。因此，我们需要流程来帮助我们在保持高可用性的同时，安全地对系统进行定期更改。

## 设计高度可用系统的原则

那么，哪些原则有助于设计高度可用的系统呢？

1. **在系统中构建冗余，消除单点故障。**
   - 涉及理解诸如区域和可用区、回退机制、数据复制、高可用性对等主题。

2. **确保系统可以在不丢失数据的情况下从一台服务器切换到另一台服务器。**
   - 涉及 DNS、负载均衡、反向代理、API 网关、对等和服务发现概念。

3. **保护系统免受非典型客户端行为的影响。**
   - 示例：过多的请求、过于昂贵的请求、导致服务器崩溃的请求。
   - 机制：负载共享、限流、随机分片、基于单元的架构。

4. **保护系统免受其依赖项的故障和性能下降的影响。**
   - 采用设计模式：超时、熔断器、隔板模式。
   - 系统必须知道何时以及如何重试对其依赖项的失败请求，并了解在何种条件下重试不再安全。

5. **在故障发生时检测它们。**
   - 在系统架构的所有层级进行监控。
   - 知道什么地方发生了故障以及在哪里，以隔离问题并快速恢复，理想情况下是自动的。

## 确保高可用性的流程

我们将快速浏览系统必须遵循的必要流程，以被认为是高度可用的。

- **变更管理流程**：确保所有代码和配置更改都由代码作者以外的人进行审查和批准。

- **测试**：创建并定期执行测试，验证新引入的更改是否满足功能和非功能性需求。

- **自动化部署流水线**：频繁、快速、安全地将更改部署到生产环境。流水线必须能够在检测到错误时快速处理所有更改并回滚更改。

- **资源监控和扩展**：监控系统利用率，及时添加资源以满足不断增长的需求。

- **灾难恢复计划**：制定计划，在发生灾难（例如自然灾害或大规模技术故障）时快速恢复系统。

- **定期故障切换测试**：定期测试到灾难恢复系统的故障切换。

- **事后分析**：在发生事件后（它们肯定会发生），执行事后分析，以确定故障的根本原因并确定预防措施。

- **运营就绪评审**：在推出任何重大新功能之前，并且此后定期（例如每年一次），对系统进行运营就绪评审，以评估其运营状态并识别运营中的差距。

如果所有的设计原则都被应用，并且这些流程都被建立起来，我们可以说我们的系统是高度可用的。差不多。剩下的就是使用一种称为**游戏日**的程序定期验证这一点。在游戏日，我们模拟故障或事件，例如系统上的突然高负载、各种依赖项故障等。我们测试系统和团队对模拟事件的响应。

## 团队文化

构建高度可用系统的最后一个非常重要的要素是**团队**，确切地说是**团队文化**。如果没有良好的团队文化，很难强制执行流程纪律。

我之前提到，对于高度可用的系统，高正常运行时间不是目标，而是副产品。这意味着高度可用的系统将具有几个九的可用性，因为它是这样设计、实现和维护的。但老实说，当我说数字不是目标时，我有点狡猾。

在构建系统时，我们需要为客户保证一个最低的可用性值。毫无根据地声称我们的系统是高度可用的，至少是不公平的。我们需要承诺一个特定的数字。这样的数字称为**服务水平目标（SLO）**，它可以是单个值或一系列值。我们（服务提供商）与系统客户之间的这种承诺称为**服务水平协议（SLA）**。

例如，Amazon DynamoDB 承诺 **四个九** 的可用性（99.99%）。如果 DynamoDB 未能达到这一承诺，AWS 将补偿客户。所有的公共云服务提供商都遵循这一规则。
