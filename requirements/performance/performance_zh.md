# 系统设计中的性能：延迟和吞吐量

当人们听到**性能**时，通常会想到处理某件事情所需的时间或处理某件事情的速率。可能两者都有。让我们澄清一下。

- 当你点击一个视频的播放按钮时，你希望内容尽快传输到你的设备上。对于视频托管服务来说，一个非功能性需求是确保**下载时间短**，即使在网络条件不佳的情况下。所以，**时间**很重要。
- 但当你决定点赞或点踩一个视频时，你并不关心完成此操作所需的时间——无论你的反应是立即被计数还是几分钟后被计数。尽管如此，我们期望系统能够准确地处理来自所有用户的所有反应。在这种情况下，重要的是系统在给定时间段内能够处理**多少反应**。换句话说，**处理速率**很重要。

**时间**和**速率**这两个术语太笼统了。在软件工程中，我们使用**延迟**和**吞吐量**这两个术语。让我们详细讨论一下这两个术语。

## 延迟

当客户端发出请求时，请求首先在网络上传输，然后到达服务器进行处理，随后响应返回客户端。响应请求所花费的总时间称为**响应时间**。

- **响应时间** = **网络延迟**（请求和响应在网络上传输的时间）+ **服务时间**（服务器处理请求的时间）

我们可以进一步分解公式，包括：

- 服务器端从套接字读取数据所需的时间。
- 请求在队列中等待处理的时间。

但为了讨论的简洁性，我们保持简单。

### 延迟的不同解释

人们对**延迟**有不同的理解：

- 有些人指**网络延迟**，称为**网络延迟**。
- 有些人指**服务时间**，有时会指定为**服务器端延迟**。
- 有些人将**响应时间**称为延迟，可能会指定为**客户端延迟**。

因为**延迟**可能意味着网络延迟、服务时间、响应时间或其他含义，理解上下文非常重要。如果不确定，请与你的面试官或团队成员澄清。

### 测量延迟

延迟从来都不是一个固定的数字。不同的请求，即使来自同一客户端，也会有不同的网络延迟、处理时间和响应时间。

有两种常见的方法来测量延迟：

1. **平均延迟**：
   - 计算单个请求延迟的总和，除以请求总数。
   - 易于计算，但可能具有误导性，因为它不能准确反映用户体验。

2. **百分位数**：
   - 将给定时间间隔（例如一分钟）内的所有请求按延迟排序。
   - **P50（中位数）**：50%的请求延迟小于等于该值。
   - **P99**：99%的请求延迟小于等于该值。
   - 我们关注高百分位数（如P99），以改善受影响最严重用户的体验。

### 优化延迟

作为工程师，我们的目标是调查高延迟，找出根本原因，努力减少**尾延迟**。但我们应该将延迟减少多少呢？

- 如果P99延迟为3秒太高，2秒可以接受吗？1秒呢？
- 进一步降低延迟可能需要大量努力。
- 我们需要将选定的百分位数（例如P99）优化到合理的程度（例如1秒），然后坚持这个数字。
- 然后我们可以将此数字承诺给客户，作为**SLA**（服务级别协议）的一部分。

## 吞吐量

**吞吐量**是处理某事物的速率。

- 示例：
  - Web服务器每秒处理的请求数量。
  - 数据库每分钟处理的查询数量。
  - 每小时成功到达目的地的网络数据包数量。

吞吐量越高，性能越好。

### 增加吞吐量

有两种方法可以增加吞吐量：

1. **减少延迟**：
   - 处理每个请求所需的时间越少，能够处理的请求就越多。

2. **扩展系统**：
   - **垂直扩展**：为现有机器添加更多资源。
   - **水平扩展**：向系统添加更多机器。

### 示例

- **并行处理**：
  - 将一个大文件拆分成块。
  - 在单独的工作机器上并行处理每个块（MapReduce范式）。

- **消息队列**：
  - 如果一个消费者无法跟上，可以添加更多消费者。
  - 如果多个消费者不能从同一队列读取，创建多个队列并分发消息。

- **数据库分片**：
  - 将数据库拆分为多个实例（分片），每个实例存储一部分数据。
  - 将写操作分布到各个分片上。

- **缓存系统**：
  - 在多个缓存实例上复制数据。
  - 允许每个副本处理读取请求。

## 带宽

在讨论吞吐量时，提及**带宽**很重要：

- **带宽**是给定路径上的最大数据传输速率，通常以每秒比特数衡量。
- **类比**：
  - 将带宽想象为一根管道。
  - 将吞吐量想象为流过管道的水。
    - 如果管道被水填满，吞吐量等于带宽。
    - 如果管道只有一半满，吞吐量等于带宽的一半。

在尝试增加系统吞吐量时，记住带宽这一点。有时，我们只需要更大的管道来实现更高的吞吐量，特别是在扩展网络资源时，需要向服务器传输更多数据。
